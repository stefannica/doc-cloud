<?xml version="1.0"?>
<!DOCTYPE section [
 <!ENTITY % entities SYSTEM "entities.ent"> %entities;
]>
<!---->
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="config_3par"><title><phrase><phrase><phrase><phrase>[[[kw-hos-tm]]] [[[kw-hos-version-50]]]: </phrase></phrase></phrase></phrase>Configuring for 3PAR Block Storage
    Backend</title><abstract><para><para>Installation and configuration steps for your 3PAR
      backend.</para>This page describes how to configure your 3PAR backend for the HPE Helion
    Entry-scale with KVM cloud model. It consists of the following steps:</para>
</abstract><!---->
    <para><para xml:id="idg-all-installation-configure_3par-xml-4"><phrase><phrase/></phrase></para></para>

    <para>
      Expand All Sections
      Collapse All Sections
    </para>

    <formalpara xml:id="idg-all-installation-configure_3par-xml-7"><title>Prerequisites</title><itemizedlist>
          <listitem><para>You must have the license for the following software before you start your 3PAR
            backend configuration for the Helion Entry-scale with KVM cloud model:</para>
<itemizedlist xml:id="ul_b11_g23_nw">
              <listitem><para>Thin Provisioning</para>
</listitem>
              <listitem><para>Virtual Copy</para>
</listitem>
              <listitem><para>System Reporter</para>
</listitem>
              <listitem><para>Dynamic Optimization </para>
</listitem>
              <listitem><para>Priority Optimization </para>
</listitem>
            </itemizedlist></listitem>
          <listitem><para>Your HPE Helion Entry-scale KVM Cloud should be up and running. Installation steps can
            be found <xref linkend="install_kvm"/>.</para>
</listitem>
          <listitem><para>Your 3PAR Storage Array should be available in the cloud management network or routed
            to the cloud management network and the 3PAR FC and iSCSI ports configured.</para>
</listitem>
          <listitem><para>The 3PAR management IP and iSCSI port IPs must have connectivity from the controller
            and compute nodes.</para>
</listitem>
          <listitem><para>Please refer to the system requirements for 3PAR in the OpenStack configuration guide,
            which can be found here: <link xlink:href="http://docs.openstack.org/liberty/config-reference/content/hp-3par-sys-reqs.html">3PAR System Requirements</link>.</para>
</listitem>
        </itemizedlist>
</formalpara>

    <formalpara xml:id="idg-all-installation-configure_3par-xml-9"><title>Notes</title><para><para><emphasis role="bold">Encrypted 3Par Volume</emphasis>: Attaching an encrypted 3Par volume is possible after installation by setting
          <literal>volume_use_multipath = true</literal> under the libvirt stanza in the
          <literal>nova/kvm-hypervisor.conf.j2</literal> file and reconfigure nova.
        </para><para xml:id="idg-all-installation-configure_3par-xml-10"><emphasis role="bold">Concerning using multiple backends:</emphasis> If you are using multiple
          backend options, ensure that you specify each of the backends you are using when
          configuring your <literal>cinder.conf.j2</literal> file using a comma delimited list. An
          example would be <literal>enabled_backends=vsa-1,3par_iSCSI,ceph1</literal> and is included
          in the steps below. You will also want to create multiple volume types so you can specify
          which backend you want to utilize when creating volumes. These instructions are included
          below as well. In addition to our documentation, you can also read the OpenStack
          documentation at <link xlink:href="http://docs.openstack.org/admin-guide-cloud/blockstorage_multi_backend.html">Configure multiple storage backends</link> as
          well.<!----></para><para><emphasis role="bold">Concerning iSCSI and Fiber Channel:</emphasis> You should not configure cinder backends so
          that multipath volumes are exported  over both iSCSI and Fiber Channel from a 3PAR backend
          to the same Nova compute server.<!----></para><para><emphasis role="bold">3PAR driver has updated name:</emphasis> In the OpenStack Mitaka release, the 3PAR driver
          used for HPE Helion integration had its name updated from <literal>HP3PARFCDriver</literal>
          and <literal>HP3PARISCSIDriver</literal> to <literal>HPE3PARFCDriver</literal> and
            <literal>HPE3PARISCSIDriver</literal>. To prevent issues when upgrading from previous
            [[[kw-hos]]] releases, we left the names as-is in the release and provided
          a mapping so that the integration would continue to work. This will produce a warning in
          the <literal>cinder-volume.log</literal> file advising you of the deprecated name. The
          warning will look similar to
          this:<screen>Option "hp3par_api_url" from group "&lt;your section&gt;" is deprecated. Use option "hpe3par_api_url" from group "&lt;your section&gt;"'</screen></para><para>These are just warnings and can be ignored.</para><!----></para>
</formalpara>
    <formalpara xml:id="idg-all-installation-configure_3par-xml-11"><title>Multipath Support</title><para><para>If you want to enable multipath for Cinder volumes carved from 3PAR FC/iSCSI storage
          system, please go through the
            <literal>~/helion/hos/ansible/roles/multipath/README.md</literal> file on the lifecycle
          manager. The README.md file contains detailed procedures for configuring multipath for
          3PAR FC/iSCSI Cinder volumes.</para><para>We have also included an additional set of steps needed if you are using 3PAR FC/iSCSI
          multipath which is included below.</para><para>If you are using 3PAR FC/iSCSI multipath, an additional configuration is required:
            
        </para></para>
<orderedlist>
          <listitem><para>Log in to the lifecycle manager.</para>
</listitem>
          <listitem><para>Edit the <literal>~/helion/my_cloud/config/nova/kvm-hypervisor.conf.j2</literal> file
            add this line under the <literal>[libvirt]</literal> section:
            </para>
<para>Example:</para>
<screen>[libvirt]
...
iscsi_use_multipath=true</screen></listitem>
          <listitem><para>Edit the <literal>~/helion/my_cloud/config/cinder/cinder.conf.j2</literal> file add this
            line under the <literal>[DEFAULT]</literal> section:
            </para>
<para>Example:</para>
<screen>[DEFAULT]
...
use_multipath_for_image_xfer=true</screen></listitem>
          <listitem><para>Commit your configuration to the <xref linkend="using_git"/>, as
            follows:
            </para>
<screen>cd ~/helion/hos/ansible
git add -A
git commit -m "My config or other commit message"</screen></listitem>
          <listitem><para>Run the configuration processor:
            </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</screen></listitem>
          <listitem><para>Use the playbook below to create a deployment directory:
            </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</screen></listitem>
          <listitem><para>Run the Nova reconfigure playbook:
            </para>
<screen>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts nova-reconfigure.yml</screen></listitem>
        </orderedlist>
</formalpara>

    <formalpara xml:id="config_fc"><title>Configure 3PAR FC as a Cinder Backend</title><para><para>You must modify the <literal>cinder.conf.j2</literal> to configure the FC details.</para><para>Perform the following steps to configure 3PAR FC as Cinder backend:</para></para>
<orderedlist>
          <listitem><para>Log in to lifecycle manager.</para>
</listitem>
          <listitem><para>Make the following changes to the
              <literal>~/helion/my_cloud/config/cinder/cinder.conf.j2</literal> file: </para>
<orderedlist>
              <listitem><para>Add your 3PAR backend to the <literal>enabled_backends</literal> section:
                  </para>
<screen># Configure the enabled backends
enabled_backends=3par_FC</screen><important><para>If you are using multiple backend types, you can use a comma
                  delimited list here. For example, if you are going to use both VSA and 3par
                  backends, you would specify something like this:
                    <literal>enabled_backends=vsa-1,3par_FC</literal>.</para>
</important></listitem>
              <listitem><para>[OPTIONAL] If you want your volumes to use a default volume type, then enter the
                name of the volume type in the <literal>[DEFAULT]</literal> section with the syntax
                below. <emphasis role="bold">You will want to remember this value when you create your volume type in
                  the next section.</emphasis></para>
<important><para>If you do not specify a default type then your volumes will
                    default to a non-redundant RAID configuration. It is recommended that you create
                    a volume type and specify it here that meets your environments needs.</para>
</important>
<screen>[DEFAULT]
# Set the default volume type
default_volume_type = &lt;your new volume type&gt;</screen></listitem>
              <listitem><para>Uncomment the <literal>StoreServ (3par) iscsi cluster</literal> section and fill the
                values per your cluster information. Here is an example:
                </para>
<screen>[3par_FC]
san_ip: &lt;3par-san-ipaddr&gt;
san_login: &lt;3par-san-username&gt;
san_password: &lt;3par-san-password&gt;
hp3par_username: &lt;3par-username&gt;
hp3par_password: &lt;hp3par_password&gt;
hp3par_api_url: https://&lt;3par-san-ipaddr&gt;:8080/api/v1
hp3par_cpg: &lt;3par-cpg-name-1&gt;[,&lt;3par-cpg-name-2&gt;, ...]
volume_backend_name: &lt;3par-backend-name&gt;
volume_driver: cinder.volume.drivers.san.hp.hp_3par_fc.HP3PARFCDriver</screen></listitem>
            </orderedlist><important><para>Do not use <literal>backend_host</literal> variable in
                <literal>cinder.conf</literal> file. If <literal>backend_host</literal> is set, it will
              override the [DEFAULT]/host value which [[[kw-hos-phrase]]] is dependent
              on.</para>
</important></listitem>
          <listitem><para>Commit your configuration to the <xref linkend="using_git"/>, as follows:
            </para>
<screen>cd ~/helion/hos/ansible
git add -A
git commit -m "My config or other commit message"</screen></listitem>
          <listitem><para>Run the configuration processor:
            </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</screen></listitem>
          <listitem><para>Update your deployment directory:
            </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</screen></listitem>
          <listitem><para>Run the following playbook to complete the configuration:
            </para>
<screen>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts cinder-reconfigure.yml</screen></listitem>
        </orderedlist>
</formalpara>

    <formalpara xml:id="config_iscsi"><title>Configure 3PAR iSCSI as Cinder backend</title><para><para>You must modify the <literal>cinder.conf.j2</literal> to configure the iSCSI details.</para><para>Perform the following steps to configure 3PAR iSCSI as Cinder backend:</para></para>
<orderedlist xml:id="iSCSI">
          <listitem><para>Log in to lifecycle manager.</para>
</listitem>
          <listitem><para>Make the following changes to the
              <literal>~/helion/my_cloud/config/cinder/cinder.conf.j2</literal> file: </para>
<orderedlist>
              <listitem><para>Add your 3PAR backend to the <literal>enabled_backends</literal> section:
                </para>
<screen># Configure the enabled backends
enabled_backends=3par_iSCSI</screen></listitem>
              <listitem><para>Uncomment the <literal>StoreServ (3par) iscsi cluster</literal> section and fill the
                values per your cluster information. Here is an example:
                  </para>
<screen>[3par_iSCSI]
san_ip: &lt;3par-san-ipaddr&gt;
san_login: &lt;3par-san-username&gt;
san_password: &lt;3par-san-password&gt;
hp3par_username: &lt;3par-username&gt;
hp3par_password: &lt;hp3par_password&gt;
hp3par_api_url: https://&lt;3par-san-ipaddr&gt;:8080/api/v1
hp3par_cpg: &lt;3par-cpg-name-1&gt;[,&lt;3par-cpg-name-2&gt;, ...]
volume_backend_name: &lt;3par-backend-name&gt;
volume_driver: cinder.volume.drivers.san.hp.hp_3par_iscsi.HP3PARISCSIDriver
hp3par_iscsi_ips: &lt;3par-ip-address-1&gt;[,&lt;3par-ip-address-2&gt;,&lt;3par-ip-address-3&gt;, ...]
hp3par_iscsi_chap_enabled=true</screen><important><para>Do not use <literal>backend_host</literal> variable in
                    <literal>cinder.conf</literal> file. If <literal>backend_host</literal> is set, it
                  will override the [DEFAULT]/host value which [[[kw-hos-phrase]]] is
                  dependent on.</para>
</important></listitem>
            </orderedlist></listitem>
          <listitem><para>Commit your configuration your local git repository:
            </para>
<screen>cd ~/helion/hos/ansible
git add -A
git commit -m "&lt;commit message&gt;"</screen></listitem>
          <listitem><para>Run the configuration processor:
              </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</screen><para>When
              you run the configuration processor you will be prompted for two passwords. Enter the
              first password to make the configuration processor encrypt its sensitive data, which
              is comprised of the random inter-service passwords that it generates and the Ansible
              group_vars and host_vars that it produces for subsequent deploy runs. You will need
              this key for subsequent Ansible deploy runs and subsequent configuration processor
              runs. If you wish to change an encryption password that you have already used when
              running the configuration processor then enter the new password at the second prompt,
              otherwise just press carriage return.</para>
<para>For CI purposes you can specify the
              required passwords on the ansible command line. For example, the command below will
              disable encryption by the configuration processor
              </para>
<screen>ansible-playbook -i hosts/localhost config-processor-run.yml -e encrypt="" -e rekey=""</screen>
<para>
              If you receive an error during either of these steps then there is an issue with one
              or more of your configuration files. We recommend that you verify that all of the
              information in each of your configuration files is correct for your environment and
              then commit those changes to git using the instructions above.</para>
</listitem>
          <listitem><para>Run the following command to create a deployment directory.
            </para>
<screen>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</screen></listitem>
          <listitem><para>Run the following command to complete the configuration:
            </para>
<screen>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts cinder-reconfigure.yml</screen></listitem>
        </orderedlist>
</formalpara>

    <formalpara xml:id="idg-all-installation-configure_3par-xml-16"><title>Post-Installation Tasks</title><para><para>After you have configured 3PAR as your Block Storage backend, here are some tasks you
          will want to complete:</para></para>
<itemizedlist>
          <listitem/>
          <listitem/>
        </itemizedlist>
</formalpara>
  </section>
